brooklyn.catalog:
  id: ArtifactoryHaCluster
  version: 1.0
  description: Artifactory HA Cluster

services:
- type: brooklyn.entity.basic.VanillaSoftwareProcess
  name: Artifactory HA Cluster
  launch.command: |
  
    # Install prerequisite tools
    sudo apt-get update
    sudo apt-get -y install wget unzip nfs-kernel-server
    
    # Download and unzip Artifactory package
    sudo wget --output-document=artifactory.zip $ARTIFACTORY_DOWNLOAD_URL
    sudo unzip artifactory.zip
    sudo rm artifactory.zip
    sudo mv artifactory-* artifactory
    
    # Create cluster home folder
    sudo mkdir -p ${ARTIFACTORY_CLUSTER_HOME}/ha-etc
    
    # Create cluster.properties file and add security token
    echo security.token=$ARTIFACTORY_SECURITY_TOKEN | sudo tee --append ${ARTIFACTORY_CLUSTER_HOME}/ha-etc/cluster.properties > /dev/null
    
    # Copy in necessary Artifactory files
    sudo cp artifactory/etc/{artifactory.system.properties,mimetypes.xml} ${ARTIFACTORY_CLUSTER_HOME}/ha-etc
    sudo cp artifactory/misc/db/mysql.properties ${ARTIFACTORY_CLUSTER_HOME}/ha-etc/storage.properties
    
    # Configure MySQL storage.properties file
    sudo sed -i "s/localhost/${ARTIFACTORY_DB_SERVER_IP}/g" ${ARTIFACTORY_CLUSTER_HOME}/ha-etc/storage.properties
    sudo sed -i "s/username=artifactory/username=${ARTIFACTORY_DB_SERVER_USERNAME}/g" ${ARTIFACTORY_CLUSTER_HOME}/ha-etc/storage.properties
    sudo sed -i "s/password=password/password=${ARTIFACTORY_DB_SERVER_PASSWORD}/g" ${ARTIFACTORY_CLUSTER_HOME}/ha-etc/storage.properties
    
    # Edit NFS exports file
    IFS=';' read -ra IPS <<< "$ARTIFACTORY_NODES_IPS"
    for i in "${IPS[@]}"; do
        echo "$ARTIFACTORY_CLUSTER_HOME ${i}(rw,sync,no_root_squash)" | sudo tee --append /etc/exports > /dev/null
    done
    
    # Start NFS server
    sudo service nfs-kernel-server restart
    
  checkRunning.command: sudo service nfs-kernel-server status
  stop.command: sudo service nfs-kernel-server stop
  
  brooklyn.config:
    artifactory.download.url: http://bit.ly/Hqv9aj
    artifactory.cluster.home: /clusterhome
    artifactory.security.token: 76b07383dcda344979681e01efa5ac50
    artifactory.db.server.ip: 108.168.144.210
    artifactory.db.server.username: artifactory
    artifactory.db.server.password: passw0rd
    artifactory.nodes.ips: "108.168.144.212;108.168.144.221"
        
    shell.env: 
      ARTIFACTORY_DOWNLOAD_URL: $brooklyn:config("artifactory.download.url")
      ARTIFACTORY_CLUSTER_HOME: $brooklyn:config("artifactory.cluster.home")
      ARTIFACTORY_SECURITY_TOKEN: $brooklyn:config("artifactory.security.token")
      ARTIFACTORY_DB_SERVER_IP: $brooklyn:config("artifactory.db.server.ip")
      ARTIFACTORY_DB_SERVER_USERNAME: $brooklyn:config("artifactory.db.server.username") 
      ARTIFACTORY_DB_SERVER_PASSWORD: $brooklyn:config("artifactory.db.server.password")
      ARTIFACTORY_NODES_IPS: $brooklyn:config("artifactory.nodes.ips")
